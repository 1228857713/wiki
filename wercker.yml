box: node:8-alpine
build:
  steps:
    - script:
      name: install dependencies
      code: |
        apk update
        apk add bash build-base curl git openssh yarn
    - script:
      name: yarn install
      code: |
        yarn config set cache-folder "$WERCKER_CACHE_DIR/yarn"
        yarn install
    - script:
      name: build
      code: yarn run build
    - npm-test

deploy-github:
  steps:
    - script:
      name: package
      code: |
        tar -chzfv wiki-js.tar.gz * -X .build/.deployexclude
        yarn install --production --ignore-scripts --prefer-offline
        tar -chzfv node_modules.tar.gz node_modules
        SEMVER_LAST=`npm show wiki.js version`
        chmod +x ./.build/semver_next.sh
        SEMVER_NEXT=`./.build/semver_next.sh -p $SEMVER_LAST`
    - github-create-release:
      token: $GITHUB_TOKEN
      tag: "v${SEMVER_NEXT}"
      prerelease: true
    - github-upload-asset:
      token: $GITHUB_TOKEN
      file: wiki-js.tar.gz
    - github-upload-asset:
      token: $GITHUB_TOKEN
      file: node_modules.tar.gz

deploy-docker-master:
  steps:
    - script:
      name: remove dev dependencies
      code: |
        yarn install --production --ignore-scripts --prefer-offline
        apk update
        apk del build-base yarn
    - internal/docker-push:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
        tag: latest, master
        ports: "3000"
        entrypoint: node server
        repository: requarks/wiki
        registry: https://registry.hub.docker.com

deploy-docker-dev:
  steps:
    - internal/docker-push:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
        tag: dev
        ports: "3000"
        entrypoint: node server
        repository: requarks/wiki
        registry: https://registry.hub.docker.com
